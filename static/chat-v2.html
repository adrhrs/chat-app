<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="https://freepngimg.com/thumb/chat/159738-photos-speech-chat-icon-free-hd-image.png">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <title>Chat App New</title>
</head>

<body>

    <div class="container">
        <div class="row m-5">
            <div class="col-4">
                <h3>Active Users</h3>
                <div class="list-group" id="user-list" role="tablist"></div>
            </div>
            <div class="col-8">
                <h3>Hi <span id="name">Guest</span>! </h3>
                <div class="card">
                    <div class="card-body" id="convo"></div>
                </div>
                <form onsubmit="sendMsg(); return false;">
                    <div class="row mt-2">
                        <div class="col-lg-10">
                            <input class="form-control" id="msg"></input>
                        </div>
                        <div class="col-lg-2 d-grid">
                            <button type="submit" class="btn btn-outline-primary btn-sm btn-block">Send</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    var app = {}
    app.ws = undefined
    var name = ""
    var host = "localhost"

    const userListElemID = "user-list"
    const msgElemID = "msg"
    const convoElemID = "convo"

    const listUser = "list_user"
    const regularChat = "reg_chat"

    var selectedUser = ""
    var messages = new Map()


    // core func
    app.init = function() {

        name = prompt('Enter your name please:') || "guest"
        document.getElementById("name").innerHTML = name

        app.ws = new WebSocket("ws://" + host + ":8080/ws?username=" + name)
        app.ws.onopen = function() {
            console.log("connected")
        }
        app.ws.onmessage = function(event) {
            var eventData = JSON.parse(event.data)
            if (eventData.type === listUser) {
                loadActiveUser(eventData)
                console.log("selected user", selectedUser)
            } else if (eventData.type === regularChat) {
                receiveMsg(eventData)
            }
        }
    }

    // conversation functions

    function storeMsg(key, msg) {
        if (messages[key] === undefined) {
            messages[key] = [msg]
        } else {
            messages[key].push(msg)
        }
        console.log(messages, selectedUser, key)

        if (selectedUser === key) {
            renderMsg(msg)
        }
    }

    function renderAllMsg(msgs) {


        for (msg of msgs) {
            renderMsg(msg);
        }
    }

    function renderMsg(data) {

        convo = document.getElementById(convoElemID)
        row = document.createElement("div")
        row.className = 'row mb-2'

        if (data.from === name) {
            col = document.createElement("div")
            col.className = 'col-lg-6 offset-lg-6'

            card = document.createElement("div")
            card.className = 'card text-white bg-primary'
        } else {
            col = document.createElement("div")
            col.className = 'col-lg-6'

            card = document.createElement("div")
            card.className = 'card text-white bg-secondary'
        }

        cardBody = document.createElement("div")
        cardBody.className = 'card-body'
        cardBody.innerHTML = data.msg

        card.appendChild(cardBody)
        col.appendChild(card)
        row.appendChild(col)
        convo.appendChild(row)

    }

    function receiveMsg(data) {
        msgs = {
            from: data.from,
            msg: data.msg,
            to: name
        }
        storeMsg(msgs.from, msgs)
    }

    function sendMsg() {
        msgForm = document.getElementById(msgElemID)
        msgs = {
            from: name,
            msg: msgForm.value,
            to: selectedUser
        }
        storeMsg(msgs.to, msgs)
        app.ws.send(JSON.stringify(msgs))
        msgForm.value = ''
    }

    //active user functions

    function loadActiveUser(data) {
        selectedUser = name
        resetUserList()
        userList = data.msg.split(",")
        userList.forEach(renderUserList)
    }

    function resetUserList() {
        userListElem = document.getElementById(userListElemID)
        userListElem.innerHTML = ''
    }

    function renderUserList(value, index, array) {
        userListElem = document.getElementById(userListElemID)
        user = document.createElement("a")
        user.className = 'list-group-item list-group-item-action'
        user.innerHTML = value
        user.id = value

        if (value === name) {
            user.classList.add("disabled")
        }

        user.onclick = function() {
            handleSelectedUser(this)
        }
        userListElem.appendChild(user)
    }

    function handleSelectedUser(data) {
        currSelectedUser = document.getElementById(selectedUser)
        currSelectedUser.className = 'list-group-item list-group-item-action'
        data.classList.add("active");
        selectedUser = data.innerHTML

        convo = document.getElementById(convoElemID)
        convo.innerHTML = ''
        if (messages[selectedUser] !== undefined) {
            renderAllMsg(messages[selectedUser])
        }

        console.log("from", name, "target (selectedUser) :", selectedUser)
    }

    window.onload = app.init
</script>

</html>